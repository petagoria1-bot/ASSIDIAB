rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions d'aide (Helpers) ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Vérifie si l'utilisateur est un membre ACCEPTÉ du cercle du patient
    function isAcceptedMember(patientId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.status == 'accepted';
    }
    
    // Vérifie si un membre a les droits de LECTURE
    function hasReadRights(patientId) {
        return isAcceptedMember(patientId) && 
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.read == true;
    }
    
    // Vérifie si un membre a les droits d'ÉCRITURE
    function hasWriteRights(patientId) {
        return isAcceptedMember(patientId) &&
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.write == true;
    }

    // --- Profils Utilisateurs (/users) ---
    // Un utilisateur peut lire et mettre à jour son propre profil.
    match /users/{uid} {
      allow read, update: if isUser(uid);
      allow create: if false; // La création est gérée par une Cloud Function (onAuthUserCreate)
    }

    // --- Collection des Patients (/patients) ---
    match /patients/{patientId} {
      // Seul un utilisateur peut créer son propre profil patient
      allow create: if isUser(patientId);
      
      // Le patient lui-même ou un membre accepté avec droits de lecture peut lire le profil
      allow read: if isUser(patientId) || hasReadRights(patientId);
      
      // Seul le patient peut mettre à jour les données de son profil
      allow update: if isUser(patientId);

      // --- Sous-collection des Membres du Cercle (/circleMembers) ---
      match /circleMembers/{memberId} {
          // Le patient (propriétaire), le membre lui-même, ou un autre membre accepté peut voir la liste des membres.
          allow read: if isUser(patientId) || isUser(memberId) || isAcceptedMember(patientId);
          
          // Le patient (propriétaire) peut créer/gérer les membres.
          // CORRECTION CRITIQUE: Permet la création du membre 'owner' lors de l'initialisation du profil.
          allow write: if isUser(patientId); 
      }
    }

    // --- Groupe de Collections pour 'circleMembers' ---
    // Règle pour les soignants : leur permet de trouver les patients auxquels ils sont rattachés.
    match /{path=**}/circleMembers/{memberId} {
      allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
    }

    // --- Collection des Invitations (/invitations) ---
    // Gérée entièrement par des Cloud Functions sécurisées.
    match /invitations/{invitationId} {
        allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
        allow write: if false;
    }

    // --- Collection des Entrées de Journal (/entries) ---
    match /entries/{entryId} {
      // Permet la lecture au patient ou aux membres avec droits de lecture.
      // Compatible avec la requête `where('uid', '==', patientId)`.
      allow read: if isUser(resource.data.uid) || hasReadRights(resource.data.uid);
      
      // Permet l'écriture (création, mise à jour, suppression) au patient ou aux membres avec droits d'écriture.
      allow write: if isUser(request.resource.data.uid) || hasWriteRights(request.resource.data.uid);
    }
  }
}
