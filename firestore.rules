rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions d'aide (Helpers) ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Vérifie si l'utilisateur est un membre ACCEPTÉ du cercle du patient.
    // NOTE: Cette fonction utilise get() et ne doit pas être utilisée dans une règle de type `list`.
    function isAcceptedMember(patientId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.status == 'accepted';
    }
    
    // Vérifie si un membre a les droits de LECTURE.
    function hasReadRights(patientId) {
        return isAcceptedMember(patientId) && 
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.read == true;
    }
    
    // Vérifie si un membre a les droits d'ÉCRITURE.
    function hasWriteRights(patientId) {
        return isAcceptedMember(patientId) &&
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.write == true;
    }

    // --- Profils Utilisateurs (/users) ---
    // Un utilisateur peut lire et mettre à jour son propre profil.
    match /users/{uid} {
      allow read, update: if isUser(uid);
      allow create: if false; // La création est gérée par la Cloud Function onAuthUserCreate.
    }

    // --- Collection des Patients (/patients) ---
    match /patients/{patientId} {
      // Seul un utilisateur peut créer son propre profil patient.
      allow create: if isUser(patientId);
      
      // Le patient lui-même ou un membre accepté avec droits de lecture peut lire le profil.
      allow read: if isUser(patientId) || hasReadRights(patientId);
      
      // Seul le patient peut mettre à jour les données de son profil (PAI, etc.).
      allow update: if isUser(patientId);

      // --- Sous-collection des Membres du Cercle (/circleMembers) ---
      match /circleMembers/{memberId} {
          // Règle pour lire un seul document (get).
          // Le patient, ou le membre lui-même peut lire un document spécifique.
          allow get: if isUser(patientId) || isUser(memberId);
          
          // Règle pour lire une liste de documents (list).
          // SEUL le patient peut lister tous les membres de son cercle.
          allow list: if isUser(patientId);
          
          // Le patient (propriétaire) peut créer, modifier et supprimer les membres.
          // Indispensable pour la création du profil et la gestion du cercle.
          allow write: if isUser(patientId); 
      }
    }

    // --- Groupe de Collections pour 'circleMembers' ---
    // RÈGLE CRITIQUE pour les médecins/proches : leur permet de trouver les patients auxquels ils sont rattachés.
    // Cette règle autorise une requête `collectionGroup` sur `circleMembers`.
    match /{path=**}/circleMembers/{memberId} {
      allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
    }

    // --- Collection des Invitations (/invitations) ---
    // Gérée entièrement par des Cloud Functions sécurisées.
    match /invitations/{invitationId} {
        // Un utilisateur peut lire sa propre invitation pour en voir les détails avant de s'inscrire/répondre.
        allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
        // La création, modification, suppression sont interdites côté client.
        allow write: if false;
    }

    // --- Collection des Entrées de Journal (/entries) ---
    match /entries/{entryId} {
      // Le patient ou un membre avec droits de lecture peut lire les entrées.
      // Cette règle est compatible avec les requêtes `where('uid', '==', patientId)`.
      allow read: if isUser(resource.data.uid) || hasReadRights(resource.data.uid);
      
      // Le patient ou un membre avec droits d'écriture peut créer une entrée.
      allow create: if isUser(request.resource.data.uid) || hasWriteRights(request.resource.data.uid);

      // Le patient ou un membre avec droits d'écriture peut modifier/supprimer une entrée existante.
      allow update, delete: if isUser(resource.data.uid) || hasWriteRights(resource.data.uid);
    }
  }
}
