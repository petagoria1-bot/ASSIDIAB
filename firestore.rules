rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions d'aide (Helpers) ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Vérifie si l'utilisateur est un membre accepté du cercle du patient
    function isAcceptedMember(patientId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.status == 'accepted';
    }
    
    // Vérifie si un membre a les droits de lecture
    function hasReadRights(patientId) {
        return isAcceptedMember(patientId) && 
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.read == true;
    }
    
    // Vérifie si un membre a les droits d'écriture
    function hasWriteRights(patientId) {
        return isAcceptedMember(patientId) &&
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.write == true;
    }

    // --- Profils Utilisateurs (/users) ---
    // Un utilisateur peut lire et mettre à jour son propre profil.
    // La création est gérée par une Cloud Function à l'inscription.
    match /users/{uid} {
      allow read, update: if isUser(uid);
      allow create: if false; // Interdit la création côté client
    }

    // --- Collection des Patients (/patients) ---
    match /patients/{patientId} {
      // Seul un utilisateur peut créer son propre profil patient
      allow create: if isUser(patientId);
      
      // Le patient lui-même ou un membre accepté avec droits de lecture peut lire le profil
      allow read: if isUser(patientId) || hasReadRights(patientId);
      
      // Seul le patient peut mettre à jour les données de son profil
      allow update: if isUser(patientId);

      // --- Sous-collection des Membres du Cercle (/circleMembers) ---
      match /circleMembers/{memberId} {
          // Le patient, le membre lui-même, ou un autre membre accepté peut voir la liste des membres.
          allow read: if isUser(patientId) || isUser(memberId) || isAcceptedMember(patientId);
          
          // La création, la mise à jour et la suppression sont gérées par des Cloud Functions sécurisées.
          allow write: if false; 
      }
    }

    // --- Groupe de Collections pour 'circleMembers' ---
    // RÈGLE CRITIQUE : Permet à un soignant (médecin, etc.) de trouver les patients auxquels il est rattaché.
    // Conçue pour la requête : query(collectionGroup('circleMembers'), where('memberUserId', '==', auth.uid))
    match /{path=**}/circleMembers/{memberId} {
      allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
    }

    // --- Collection des Invitations (/invitations) ---
    // Stockage temporaire des invitations.
    match /invitations/{invitationId} {
        // Seul l'utilisateur invité peut lire son invitation.
        allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
        
        // Toutes les écritures (création, màj, suppression) sont gérées par des Cloud Functions.
        allow write: if false;
    }

    // --- Collection des Entrées de Journal (/entries) ---
    match /entries/{entryId} {
      // Permet la lecture au patient ou aux membres avec droits de lecture.
      // Cette règle est compatible avec la requête `where('uid', '==', patientId)`.
      allow read: if isUser(resource.data.uid) || hasReadRights(resource.data.uid);
      
      // Permet la création au patient ou aux membres avec droits d'écriture.
      allow create: if isUser(request.resource.data.uid) || hasWriteRights(request.resource.data.uid);

      // Seuls le patient ou les membres avec droits d'écriture peuvent modifier/supprimer.
      allow update, delete: if isUser(resource.data.uid) || hasWriteRights(resource.data.uid);
    }
  }
}
