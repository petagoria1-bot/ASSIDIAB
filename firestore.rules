rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions d'aide (Helpers) ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Vérifie si l'utilisateur est un membre ACCEPTÉ du cercle du patient.
    // NOTE: Cette fonction utilise get() et ne doit pas être utilisée dans une règle de type `list`
    // sur la collection `circleMembers` elle-même pour éviter les erreurs.
    function isAcceptedMember(patientId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.status == 'accepted';
    }
    
    // Vérifie si un membre a les droits de LECTURE
    function hasReadRights(patientId) {
        return isAcceptedMember(patientId) && 
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.read == true;
    }
    
    // Vérifie si un membre a les droits d'ÉCRITURE
    function hasWriteRights(patientId) {
        return isAcceptedMember(patientId) &&
               get(/databases/$(database)/documents/patients/$(patientId)/circleMembers/$(request.auth.uid)).data.rights.write == true;
    }

    // --- Profils Utilisateurs (/users) ---
    match /users/{uid} {
      allow read, update: if isUser(uid);
      allow create: if false; // La création est gérée par une Cloud Function
    }

    // --- Collection des Patients (/patients) ---
    match /patients/{patientId} {
      allow create: if isUser(patientId);
      allow read: if isUser(patientId) || hasReadRights(patientId);
      allow update: if isUser(patientId);

      // --- Sous-collection des Membres du Cercle (/circleMembers) ---
      match /circleMembers/{memberId} {
          // Un patient peut lire les documents de son cercle. Un membre peut lire son propre document.
          allow get: if isUser(patientId) || isUser(memberId);
          // SEUL le patient peut lister tous les membres de son cercle d'un coup.
          allow list: if isUser(patientId);
          
          // Le patient (propriétaire) peut créer/modifier/supprimer les membres.
          allow write: if isUser(patientId); 
      }
    }

    // --- Groupe de Collections pour 'circleMembers' ---
    // Règle pour les soignants : leur permet de trouver les patients auxquels ils sont rattachés
    // via une requête collectionGroup.
    match /{path=**}/circleMembers/{memberId} {
      allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
    }

    // --- Collection des Invitations (/invitations) ---
    match /invitations/{invitationId} {
        allow read: if isAuthenticated() && resource.data.memberUserId == request.auth.uid;
        allow write: if false; // Gérée par des Cloud Functions
    }

    // --- Collection des Entrées de Journal (/entries) ---
    match /entries/{entryId} {
      // Le patient ou un membre avec droits de lecture peut lire les entrées.
      allow read: if isUser(resource.data.uid) || hasReadRights(resource.data.uid);
      
      // Le patient ou un membre avec droits d'écriture peut créer une entrée.
      allow create: if isUser(request.resource.data.uid) || hasWriteRights(request.resource.data.uid);

      // Le patient ou un membre avec droits d'écriture peut modifier/supprimer une entrée existante.
      allow update, delete: if isUser(resource.data.uid) || hasWriteRights(resource.data.uid);
    }
  }
}
